#!/usr/bin/env node

// TODO:
//   * Handle RequireJS paths config somehow
//   * Break down files, add tests
//   * Represent resource type, check as input, provide as output
//   * Allow specifying multiple destinations by type
//   * Use Harmony modules and other patterns (let, etc)?

// TODO: try implement:
//   - glue (or similar)
//   - jshint
//   - karma

// TODO: usage:
//   luigi
//   luigi <pipeline>
//   luigi <pipeline> <files>


var q = require('q');

var Report = require('../src/model/report');

function execute(pipeline) {
  return pipeline.reduce(function(res, op) {
    return res.then(op);
  }, q());
}

function run(pipeline) {
    return execute(pipeline).then(function(outputs) {
        var reports = outputs.filter(function(output) {
            return output instanceof Report;
        });

        var others = outputs.filter(function(output) {
            return ! (output instanceof Report);
        });

        if (others.length === 0) {
            reports.forEach(function(report) {
                console.log("written to", report.writtenResource.absolute());
            });
        } else {
            console.log(others.length + ' unprocessed resources:');
            others.forEach(function(other) {
                console.log(other.filename());
            });
        }
    }).catch(function(err) {
        console.log("Luigi failed: ", err.stack);
    });
}


var cwd = process.cwd();
var spec = require(cwd + '/Pipeline.js');

var pipelines = {};

spec(pipelines);

var pipelineArgs = process.argv.slice(2);
if (pipelineArgs.length === 0) {
    // Run all pipelines
    pipelineArgs = Object.keys(pipelines);
}

pipelineArgs.forEach(function(pipelineArg) {
    var pipeline = pipelines[pipelineArg];
    if (! pipeline) {
        throw new Error('Pipeline not defined: ' + pipelineArg);
    }

    console.log("Run pipeline: " + pipelineArg);
    run(pipeline);
});


// TODO: allow outputing to dir, regardless of number of resources
// to(resources, 'dist/');
// to(resources, 'dist'); // exists as a dir
// to(resources, luigi.dir('dist'));
// to(resources, {javascript: 'app.js', sourcemap: 'app.js.map'});

// TODO: create target directory if missing
