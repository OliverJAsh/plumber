#!/usr/bin/env node

var nopt = require('nopt');

var run = require('../src/core').run;

var cwd = process.cwd();
var spec = require(cwd + '/Pipeline.js');

var pipelines = {};

spec(pipelines);

var cli = nopt({watch: Boolean}, {w: '--watch'}, process.argv, 2);

var pipelineArgs = cli.argv.remain;
if (pipelineArgs.length === 0) {
    // Run all pipelines
    pipelineArgs = Object.keys(pipelines);
}

pipelineArgs.forEach(function(pipelineArg) {
    var pipeline = pipelines[pipelineArg];
    if (! pipeline) {
        throw new Error('Pipeline not defined: ' + pipelineArg);
    }

    console.log("Run pipeline: " + pipelineArg);

    var finalStep = run(pipeline);

    // Report errors if any
    finalStep.output.catch(function(err) {
        console.log("Luigi failed: ", err.stack);
    });

    if (cli.watch) {
        finalStep.output.then(function() {
            var gaze = require('gaze');
            gaze(supervisor.includes, function() {
                this.on('all', function(event, filepath) {
                    console.log("Re-run pipeline: " + pipelineArg);
                    run(pipeline, supervisor);
                });
            });
        });
    }
});
